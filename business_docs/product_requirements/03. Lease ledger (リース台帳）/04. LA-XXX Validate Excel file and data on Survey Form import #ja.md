JIRA Story URL: 

Related Epic URL: 

## User Stories

As an accountant or department staff, I want the system to validate the Excel file and its data when importing the survey form, so that I can avoid import errors and ensure data quality for lease identification and reporting.

## Requirements

### Happy case

| No. | **Given**<br><span style="color: rgb(38, 38, 38)">Initial State</span> | **When**<br><span style="color: rgb(38, 38, 38)">Action</span> | **Then**<br><span style="color: rgb(38, 38, 38)">Expected Result</span> | 
| --- | --- | --- | --- |
| 1 | The import modal is open | User selects an Excel file with valid extension (.xlsx) and format, not password protected, contains the required sheet ("インポート用/for import"), and is under 15MB | File is accepted for upload |
| 2 | The import modal is open | User selects a file with invalid extension, format, password protection, missing required sheet, or over 15MB | Error message is shown, file is not accepted |
| 3 | File is accepted and user clicks Import | All data rows meet validation (string max length, numbers max 13 digits, currency min, no negative values, valid value options) | Data is imported successfully |
| 4 | File is accepted and user clicks Import | Some data rows fail validation | Error messages are shown for each failed row/field, import is blocked until errors are fixed |

### Alternative case

| No. | **Given**<br><span style="color: rgb(38, 38, 38)">Initial State</span> | **When**<br><span style="color: rgb(38, 38, 38)">Action</span> | **Then**<br><span style="color: rgb(38, 38, 38)">Expected Result</span> | 
| --- | --- | --- | --- |
| 1 | User tries to upload a file while another import is in progress | User selects a file | Error message: "Import is already in progress. Please wait until the current import is complete." |
| 2 | User uploads a file with some empty required fields | User clicks Import | Error message: "Required field is missing: [Field Name]" |

---

### Error Message List (English/Japanese)

- Invalid file extension: "Only .xlsx files are supported." / "拡張子が.xlsxのファイルのみ対応しています。"
- Invalid file format: "The file format is not supported. Please use the provided template." / "ファイル形式が正しくありません。指定のテンプレートをご利用ください。"
- File is password protected: "Password-protected files cannot be imported. Please remove the password." / "パスワード保護されたファイルはインポートできません。パスワードを解除してください。"
- Required sheet missing: "The required sheet 'インポート用/for import' is missing." / "必要なシート「インポート用」が見つかりません。"
- File size exceeds 15MB: "File size must be 15MB or less." / "ファイルサイズは15MB以下にしてください。"
- String exceeds max length: "[Field Name] must be within [Max Length] characters." / "[項目名]は[最大文字数]文字以内で入力してください。"
- Number exceeds 13 digits: "[Field Name] must be within 13 digits." / "[項目名]は13桁以内で入力してください。"
- Currency value below minimum: "[Field Name] must be at least [Min Value]." / "[項目名]は[最小値]以上で入力してください。"
- Negative value not allowed: "[Field Name] cannot be negative." / "[項目名]はマイナス値を入力できません。"
- Invalid value option: "[Field Name] contains an invalid value. Please select from the available options." / "[項目名]に無効な値が含まれています。指定の選択肢から選択してください。"
- Required field missing: "[Field Name] is required." / "[項目名]は必須項目です。"
- Import in progress: "Import is already in progress. Please wait until the current import is complete." / "インポート処理中です。完了までお待ちください。"

### Detailed Error Messages by Column (English/Japanese)

| Field (EN/JA) | Error Type | English Message | Japanese Message |
| --- | --- | --- | --- |
| Transaction name / 取引名 | Max length | Transaction name must be within 200 characters. | 取引名は200文字以内で入力してください。 |
|  | Required | Transaction name is required. | 取引名は必須項目です。 |
| Business partner code / 取引先コード | Max length | Business partner code must be within 100 characters. | 取引先コードは100文字以内で入力してください。 |
|  | Required | Business partner code is required. | 取引先コードは必須項目です。 |
| Business partner name / 取引先名 | Max length | Business partner name must be within 255 characters. | 取引先名は255文字以内で入力してください。 |
|  | Required | Business partner name is required. | 取引先名は必須項目です。 |
| Cost-bearing department code / 費用負担部門コード | Max length | Cost-bearing department code must be within 20 characters. | 費用負担部門コードは20文字以内で入力してください。 |
|  | Required | Cost-bearing department code is required. | 費用負担部門コードは必須項目です。 |
| Cost-bearing department name / 費用負担部門名 | Max length | Cost-bearing department name must be within 200 characters. | 費用負担部門名は200文字以内で入力してください。 |
|  | Required | Cost-bearing department name is required. | 費用負担部門名は必須項目です。 |
| Contract document & terms (URL) / 契約書・約款（URL） | Max length | Contract document & terms (URL) must be within 8000 characters. | 契約書・約款（URL）は8000文字以内で入力してください。 |
|  | Required | Contract document & terms (URL) is required. | 契約書・約款（URL）は必須項目です。 |
|  | Format | Contract document & terms must be a valid URL. | 契約書・約款（URL）は有効なURL形式で入力してください。 |
| Identified assets / 特定された資産 | Options | Identified assets must be 'yes' or 'no'. | 特定された資産は「yes」または「no」を選択してください。 |
|  | Required | Identified assets is required. | 特定された資産は必須項目です。 |
| Transfer of the right of use to the lessee / 借手への使用権の移転 | Options | Transfer of the right of use to the lessee must be 'yes' or 'no'. | 借手への使用権の移転は「yes」または「no」を選択してください。 |
|  | Required | Transfer of the right of use to the lessee is required. | 借手への使用権の移転は必須項目です。 |
| Regular lease payment (Excluding Tax) / 定期リース料（税抜） | Max digits | Regular lease payment must be within 13 digits. | 定期リース料（税抜）は13桁以内で入力してください。 |
|  | No negative | Regular lease payment cannot be negative. | 定期リース料（税抜）はマイナス値を入力できません。 |
|  | Required | Regular lease payment is required. | 定期リース料（税抜）は必須項目です。 |
| Lease payment frequency / リース料支払頻度 | Options | Lease payment frequency must be one of: monthly, quarterly, semiannually, annually. | リース料支払頻度は「月払い」「四半期払い」「半年払い」「年払い」から選択してください。 |
|  | Required | Lease payment frequency is required. | リース料支払頻度は必須項目です。 |
| Prepaid lease payment (excluding tax) / 前払リース料（税抜） | Max digits | Prepaid lease payment must be within 13 digits. | 前払リース料（税抜）は13桁以内で入力してください。 |
|  | No negative | Prepaid lease payment cannot be negative. | 前払リース料（税抜）はマイナス値を入力できません。 |
|  | Required | Prepaid lease payment is required. | 前払リース料（税抜）は必須項目です。 |
| Estimated payment amount due to residual value guarantee (excluding tax) / 残価保証による支払見込額（税抜） | Max digits | Estimated payment amount due to residual value guarantee must be within 13 digits. | 残価保証による支払見込額（税抜）は13桁以内で入力してください。 |
|  | No negative | Estimated payment amount due to residual value guarantee cannot be negative. | 残価保証による支払見込額（税抜）はマイナス値を入力できません。 |
|  | Required | Estimated payment amount due to residual value guarantee is required. | 残価保証による支払見込額（税抜）は必須項目です。 |
| Free rent period (months) / フリーレント期間（月数） | Max digits | Free rent period must be within 4 digits. | フリーレント期間（月数）は4桁以内で入力してください。 |
|  | No negative | Free rent period cannot be negative. | フリーレント期間（月数）はマイナス値を入力できません。 |
|  | Required | Free rent period is required. | フリーレント期間（月数）は必須項目です。 |
| Contract start date / 契約開始日 | Format | Contract start date must be in yyyy/mm/dd format. | 契約開始日はyyyy/mm/dd形式で入力してください。 |
|  | Required | Contract start date is required. | 契約開始日は必須項目です。 |
| Contract end date / 契約終了日 | Format | Contract end date must be in yyyy/mm/dd format. | 契約終了日はyyyy/mm/dd形式で入力してください。 |
|  | Required | Contract end date is required. | 契約終了日は必須項目です。 |
| Whether the cancellation option will be exercised / 解約オプションの行使有無 | Options | Whether the cancellation option will be exercised must be 'yes' or 'no'. | 解約オプションの行使有無は「yes」または「no」を選択してください。 |
|  | Required | Whether the cancellation option will be exercised is required. | 解約オプションの行使有無は必須項目です。 |
| Planned date for exercising the cancellation option / 解約オプション行使予定日 | Format | Planned date for exercising the cancellation option must be in yyyy/mm/dd format. | 解約オプション行使予定日はyyyy/mm/dd形式で入力してください。 |
|  | Required | Planned date for exercising the cancellation option is required. | 解約オプション行使予定日は必須項目です。 |
| Whether the extension option will be exercised / 延長オプションの行使有無 | Options | Whether the extension option will be exercised must be 'yes' or 'no'. | 延長オプションの行使有無は「yes」または「no」を選択してください。 |
|  | Required | Whether the extension option will be exercised is required. | 延長オプションの行使有無は必須項目です。 |
| Planned end date of the extension / 延長終了予定日 | Format | Planned end date of the extension must be in yyyy/mm/dd format. | 延長終了予定日はyyyy/mm/dd形式で入力してください。 |
|  | Required | Planned end date of the extension is required. | 延長終了予定日は必須項目です。 |
| Presence or absence of a purchase option / 購入オプションの有無 | Options | Presence or absence of a purchase option must be 'yes' or 'no'. | 購入オプションの有無は「yes」または「no」を選択してください。 |
|  | Required | Presence or absence of a purchase option is required. | 購入オプションの有無は必須項目です。 |
| Payment classification / 支払区分 | Options | Payment classification must be 'Prepayment' or 'Postpayment'. | 支払区分は「前払い」または「後払い」を選択してください。 |
|  | Required | Payment classification is required. | 支払区分は必須項目です。 |
| Ancillary costs (Excluding Tax) / 付随費用（税抜） | Max digits | Ancillary costs must be within 13 digits. | 付随費用（税抜）は13桁以内で入力してください。 |
|  | No negative | Ancillary costs cannot be negative. | 付随費用（税抜）はマイナス値を入力できません。 |
|  | Required | Ancillary costs is required. | 付随費用（税抜）は必須項目です。 |
| Presence or absence of a clause for variable lease payments / 変動リース料の条項の有無 | Options | Presence or absence of a clause for variable lease payments must be 'yes' or 'no'. | 変動リース料の条項の有無は「yes」または「no」を選択してください。 |
|  | Required | Presence or absence of a clause for variable lease payments is required. | 変動リース料の条項の有無は必須項目です。 |
| Presence or absence of a plan for ownership transfer to the lessee / 借手への所有権移転予定の有無 | Options | Presence or absence of a plan for ownership transfer to the lessee must be 'yes' or 'no'. | 借手への所有権移転予定の有無は「yes」または「no」を選択してください。 |
|  | Required | Presence or absence of a plan for ownership transfer to the lessee is required. | 借手への所有権移転予定の有無は必須項目です。 |
| Non-cancellable period (number of months) / 解約不能期間（月数） | Max digits | Non-cancellable period must be within 4 digits. | 解約不能期間（月数）は4桁以内で入力してください。 |
|  | No negative | Non-cancellable period cannot be negative. | 解約不能期間（月数）はマイナス値を入力できません。 |
|  | Required | Non-cancellable period is required. | 解約不能期間（月数）は必須項目です。 |
| Basis for the non-cancellable period / 解約不能期間の根拠 | Max length | Basis for the non-cancellable period must be within 1000 characters. | 解約不能期間の根拠は1000文字以内で入力してください。 |
|  | Required | Basis for the non-cancellable period is required. | 解約不能期間の根拠は必須項目です。 |
| Presence or absence of a cancellation option / 解約オプションの有無 | Options | Presence or absence of a cancellation option must be 'yes' or 'no'. | 解約オプションの有無は「yes」または「no」を選択してください。 |
|  | Required | Presence or absence of a cancellation option is required. | 解約オプションの有無は必須項目です。 |
| Economic incentives not to exercise the cancellation option / 解約オプションを行使しない経済的インセンティブ | Max length | Economic incentives not to exercise the cancellation option must be within 1000 characters. | 解約オプションを行使しない経済的インセンティブは1000文字以内で入力してください。 |
|  | Required | Economic incentives not to exercise the cancellation option is required. | 解約オプションを行使しない経済的インセンティブは必須項目です。 |
| Basis for the decision to exercise the cancellation option / 解約オプションの行使判断の根拠 | Max length | Basis for the decision to exercise the cancellation option must be within 1000 characters. | 解約オプションの行使判断の根拠は1000文字以内で入力してください。 |
|  | Required | Basis for the decision to exercise the cancellation option is required. | 解約オプションの行使判断の根拠は必須項目です。 |
| Presence or absence of an extension option / 延長オプションの有無 | Options | Presence or absence of an extension option must be 'yes' or 'no'. | 延長オプションの有無は「yes」または「no」を選択してください。 |
|  | Required | Presence or absence of an extension option is required. | 延長オプションの有無は必須項目です。 |
| Economic Incentive to Exercise the Extension Option / 延長オプションを行使する経済的インセンティブ | Max length | Economic Incentive to Exercise the Extension Option must be within 1000 characters. | 延長オプションを行使する経済的インセンティブは1000文字以内で入力してください。 |
|  | Required | Economic Incentive to Exercise the Extension Option is required. | 延長オプションを行使する経済的インセンティブは必須項目です。 |
| Basis for Decision to Exercise the Extension Option / 延長オプションの行使判断の根拠 | Max length | Basis for Decision to Exercise the Extension Option must be within 1000 characters. | 延長オプションの行使判断の根拠は1000文字以内で入力してください。 |
|  | Required | Basis for Decision to Exercise the Extension Option is required. | 延長オプションの行使判断の根拠は必須項目です。 |
| Notes / メモ | Max length | Notes must be within 1000 characters. | メモは1000文字以内で入力してください。 |

=======================================================================

# Excelファイル・データのバリデーション

## ユーザーストーリー

* 経理担当者・部門担当者として、調査票のExcelファイルおよびデータをインポート時にバリデーションしたい。
  なぜなら、インポートエラーやデータ不備を防ぎ、リース判定・報告の品質を担保するため。
  そのために、ファイル・データごとに明確なエラーメッセージを表示する。

## 要件

### Happy case

| No. | **Given**<br><span style="color: rgb(38, 38, 38)">初期状態</span> | **When**<br><span style="color: rgb(38, 38, 38)">アクション</span> | **Then**<br><span style="color: rgb(38, 38, 38)">期待される結果</span> | 
| --- | --- | --- | --- |
| 1 | インポートモーダルが開かれている | 有効な拡張子（.xlsx）、正しい形式、パスワード保護なし、必要なシート（「インポート用」）が存在、15MB以下のファイルを選択 | ファイルがアップロード可能 |
| 2 | インポートモーダルが開かれている | 拡張子不正、形式不正、パスワード保護、必要なシートなし、15MB超過のファイルを選択 | エラーメッセージを表示し、ファイルはアップロード不可 |
| 3 | ファイルが受理され、インポートボタンを押下 | すべてのデータ行がバリデーションを満たす | データが正常にインポートされる |
| 4 | ファイルが受理され、インポートボタンを押下 | 一部データ行がバリデーションエラー | 各エラー行・項目ごとにエラーメッセージを表示し、修正までインポート不可 |

### Alternative case

| No. | **Given**<br><span style="color: rgb(38, 38, 38)">初期状態</span> | **When**<br><span style="color: rgb(38, 38, 38)">アクション</span> | **Then**<br><span style="color: rgb(38, 38, 38)">期待される結果</span> | 
| --- | --- | --- | --- |
| 1 | 他のインポート処理が進行中 | ファイルを選択 | エラーメッセージ：「インポート処理中です。完了までお待ちください。」|
| 2 | 必須項目が空欄のファイルをアップロード | インポートボタンを押下 | エラーメッセージ：「[項目名]は必須項目です。」|

---

### エラーメッセージ一覧（英語/日本語）

- 拡張子不正：「拡張子が.xlsxのファイルのみ対応しています。」/ "Only .xlsx files are supported."
- 形式不正：「ファイル形式が正しくありません。指定のテンプレートをご利用ください。」/ "The file format is not supported. Please use the provided template."
- パスワード保護：「パスワード保護されたファイルはインポートできません。パスワードを解除してください。」/ "Password-protected files cannot be imported. Please remove the password."
- 必要なシートなし：「必要なシート「インポート用」が見つかりません。」/ "The required sheet 'インポート用/for import' is missing."
- 15MB超過：「ファイルサイズは15MB以下にしてください。」/ "File size must be 15MB or less."
- 文字数超過：「[項目名]は[最大文字数]文字以内で入力してください。」/ "[Field Name] must be within [Max Length] characters."
- 13桁超過：「[項目名]は13桁以内で入力してください。」/ "[Field Name] must be within 13 digits."
- 金額最小値未満：「[項目名]は[最小値]以上で入力してください。」/ "[Field Name] must be at least [Min Value]."
- マイナス値不可：「[項目名]はマイナス値を入力できません。」/ "[Field Name] cannot be negative."
- 選択肢不正：「[項目名]に無効な値が含まれています。指定の選択肢から選択してください。」/ "[Field Name] contains an invalid value. Please select from the available options."
- 必須項目未入力：「[項目名]は必須項目です。」/ "[Field Name] is required."
- インポート処理中：「インポート処理中です。完了までお待ちください。」/ "Import is already in progress. Please wait until the current import is complete." 